!function(){"use strict";function e(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function t(e,t,n,i,o){o&&(o=new Date(+new Date+o));var r=e+"="+escape(t)+(o?"; expires="+o.toGMTString():"")+(i?"; path="+i:"")+(n?"; domain="+n:"");return r.length<4096&&(u.cookie=r),this}function n(e){var t=u.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null}function i(e){function i(){return Math.round(2147483647*(Math.random()||.5))*+new Date%1e10}function o(){var e=d.active,t=d.url,i=e?r(t,"visitorId"):n(u);return!e&&s&&(i?f.set(u,i):i=f.get(u)),i}function c(){var e=i();return s?f.set(u,e):t(name,e,null,"/",31536e6),e}var a,u="tencentSig",s="undefined"==typeof f.type||"memory"===f.type?!0:!1,d={active:!1,url:""};return $.extend(d,e),a=o(),a||(a=c()),a}function o(){this.create=function(e,t){return this.ioLink=io.connect(e,t),this},this.close=function(){this.ioLink.disconnect()},this.emitMsg=function(e,t,n,i){return this.ioLink.compress(!1).emit(e,t),n&&n.call(i),this},this.receiveMsg=function(e,t,n,i,o){var n=n||this;return o?this.ioLink.once(e,function(e){i&&$.extend(e,i),t&&t.call(n,e)}):this.ioLink.on(e,function(e){i&&$.extend(e,i),t&&t.call(n,e)}),this}}var r=function(e,t){var n,i,e=e?e:window.location.href;if(t){n=new RegExp("[?&]"+t+"=([^&#]*)","i");try{i=n.exec(e)[1]}catch(o){i=null}}else i=e.substring(e.indexOf("?")+1);return i},c=function(e){var t=/uc_msg|oppo_night|weibo|msfapi|axure/i,n=Object.prototype.toString;return!e||"[object String]"!==n.call(e)||t.test(e)?!1:e},a=function(){function t(t,n){e(t,"message",function(e){var t=c(e.data);if(t){-1==t.indexOf(o)&&BJ_REPORT&&BJ_REPORT.report("PM NO Flag "+t);try{i=JSON.parse(t)}catch(e){throw new Error("PostMsg Parse Error "+t)}"function"==typeof n?n(i):""}},!1)}function n(e,t){var n=i?$.extend(i,e):e,c=t||r;n.hasOwnProperty(o)&&n[o]==c||(n[o]=c),n="string"!=typeof n?JSON.stringify(n):n,window.top.postMessage(n,"*")}var i,o="QD_PM",r="CHAT";return{receive:t,send:n}}(),u=document,s=function(){function e(e){return e in o?o[e]:!1}function t(e,t){return o[e]=t,!0}function n(e){var t=e in o;return t?delete o[e]:!1}function i(){return o={},!0}var o={};return{type:"memory",getItem:e,setItem:t,removeItem:n,clear:i}},f=function(e){function t(e){return r.getItem(e)}function n(e,t){try{return r.setItem(e,t),!0}catch(n){return!1}}function i(e){return r.removeItem(e)}function o(){return r.clear()}var r=s();try{"localStorage"in e&&e.localStorage&&(e.localStorage.setItem("test","test"),e.localStorage.removeItem("test"),r=e.localStorage)}catch(c){BJ_REPORT&&BJ_REPORT.report(JSON.stringify(c))}return{type:r.type,get:t,set:n,remove:i,clear:o}}(window);!function(e){var t=/iPhone/i,n=/iPod/i,i=/iPad/i,o=/(?=.*\bAndroid\b)(?=.*\bMobile\b)/i,r=/Android/i,c=/(?=.*\bAndroid\b)(?=.*\bSD4930UR\b)/i,a=/(?=.*\bAndroid\b)(?=.*\b(?:KFOT|KFTT|KFJWI|KFJWA|KFSOWI|KFTHWI|KFTHWA|KFAPWI|KFAPWA|KFARWI|KFASWI|KFSAWI|KFSAWA)\b)/i,u=/Windows Phone/i,s=/(?=.*\bWindows\b)(?=.*\bARM\b)/i,f=/BlackBerry/i,d=/BB10/i,l=/Opera Mini/i,h=/(CriOS|Chrome)(?=.*\bMobile\b)/i,v=/(?=.*\bFirefox\b)(?=.*\bMobile\b)/i,p=new RegExp("(?:Nexus 7|BNTV250|Kindle Fire|Silk|GT-P1000)","i"),m=function(e,t){return e.test(t)},b=function(e){var b=e||navigator.userAgent,g=b.split("[FBAN");return"undefined"!=typeof g[1]&&(b=g[0]),g=b.split("Twitter"),"undefined"!=typeof g[1]&&(b=g[0]),this.apple={phone:m(t,b),ipod:m(n,b),tablet:!m(t,b)&&m(i,b),device:m(t,b)||m(n,b)||m(i,b)},this.amazon={phone:m(c,b),tablet:!m(c,b)&&m(a,b),device:m(c,b)||m(a,b)},this.android={phone:m(c,b)||m(o,b),tablet:!m(c,b)&&!m(o,b)&&(m(a,b)||m(r,b)),device:m(c,b)||m(a,b)||m(o,b)||m(r,b)},this.windows={phone:m(u,b),tablet:m(s,b),device:m(u,b)||m(s,b)},this.other={blackberry:m(f,b),blackberry10:m(d,b),opera:m(l,b),firefox:m(v,b),chrome:m(h,b),device:m(f,b)||m(d,b)||m(l,b)||m(v,b)||m(h,b)},this.seven_inch=m(p,b),this.any=this.apple.device||this.android.device||this.windows.device||this.other.device||this.seven_inch,this.phone=this.apple.phone||this.android.phone||this.windows.phone,this.tablet=this.apple.tablet||this.android.tablet||this.windows.tablet,"undefined"==typeof window?this:void 0},g=function(){var e=new b;return e.Class=b,e};e.isMobile=g()}(window);var d=__domain||{chat:"chat"},l={link:"https://"+d.chat+".qidian.qq.com",opts:{path:"/status",reconnectionDelay:1e3,reconnectionDelayMax:2e3,reconnectionAttempts:2,timeout:1e3}},h={statusNotice:{emit:"active_notice"},b2cMsgNum:{receive:"b2c_msg_num",emit:"b2c_msg_num ack"},invitation:{receive:"session_invitation",emit:"user_operate"},inviteAutoConf:{emit:"invite_auto_conf",receive:"invite_auto_conf"}},v=function(e){function t(e){e&&a.send(e,"ONLINE_STATUS")}function n(e){var t=e.act;switch(t){case"SM_INIT":if(M&&M.kfuin==e.kfuin)return;M=e,M.linkType=e.linkType?1:0,k.push(M),u(M);break;case"SM_REFUSE":m();break;case"SMS_SM_FORCE_CONNECT":g();break;case"SM_INVITE_RET":p()}}function c(){var n=e.location.href,i=r(n,"kfuin");t({act:"SM_INIT",visitorId:w,kfuin:i,linkType:1,isMobile:Number(isMobile)})}function u(e){N.emitMsg(h.statusNotice.emit,e,function(t){0==t.errcode&&!S&&f(e)})}function s(){for(var e=0,t=k.length;t>e;e++)u(k[e])}function f(e){N.emitMsg(h.inviteAutoConf.emit,e),N.receiveMsg(h.inviteAutoConf.receive,function(e){t({act:"SM_INVITE_CONF",kfuin:e.body.invitationConf.kfuin,inviteRule:e.body.invitationConf})})}function d(){N.receiveMsg(h.b2cMsgNum.receive,function(e){var n=e.body,i="kfuin"+n.kfuin;N.emitMsg(h.b2cMsgNum.emit),n.number=n.msgNum,delete n.seq,delete n.msgNum,"undefined"!=typeof n.receptionName?_[i]=n.receptionName:n.receptionName=_.hasOwnProperty(i)?_[i]:null,t({act:"SM_UNREAD",kfuin:n.kfuin,data:n})})}function v(){N.receiveMsg(h.invitation.receive,function(e){var n=e.body.kfuin;delete e.body.kfuin,t({act:"SM_MANUAL_INVITE",kfuin:n,data:e.body})})}function p(e){N.emitMsg(h.invitation.emit,{operate:e})}function m(){N.emitMsg(h.invitation.emit,{action:"refuse"})}function b(e){w&&$.extend(l.opts,{query:"queryId="+w}),N.create(l.link,l.opts),N.ioLink.once("connect",function(){d(),v(),"reconnect"==e?s():(y=0,t({act:"SM_READY"}),S?c():"")}),N.ioLink.once("reconnect",function(){s()}),N.ioLink.on("disconnect",function(){t({act:"DISCONNECT"})})}function g(){N.ioLink&&N.ioLink.disconnected&&b("reconnect")}var y=0,M={},k=[],_={},w=i(),S=function(){var t=e.location.href,n=r(t,"linkType"),i=r(t,"visitorId"),o=e.parent==e?!1:!0;return i&&i.length>0?n=1:"",n&&(""+n).length>0&&!o?!0:!1}(),N=new o;return N.emitMsg=function(e,t,n,i){return this.ioLink.emit(e,t,function(){n&&n.apply(i,arguments)}),this},{start:function(){b(),a.receive(e,n)},forceConnect:g}}(window);window.__STATUS_MANAGER=v,v.start()}();